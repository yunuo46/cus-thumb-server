<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Presigned URL í…ŒìŠ¤íŠ¸</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
</head>
<body>
<div class="container">
    <h1>Google OAuth ë¡œê·¸ì¸</h1>
    <button id="google-login" class="btn btn-primary">Google ë¡œê·¸ì¸</button>

    <hr>

    <h2>ğŸ“¤ Presigned URL í…ŒìŠ¤íŠ¸</h2>

    <div class="form-group">
        <label>íŒŒì¼ ì„ íƒ (Video)</label>
        <input type="file" id="videoFile" accept="video/*" class="form-control">
        <label>í”„ë¡¬í”„íŠ¸ ì…ë ¥</label>
        <textarea id="videoPrompt" class="form-control" placeholder="í…ìŠ¤íŠ¸ ì„¤ëª… ì…ë ¥"></textarea>
        <button id="uploadVideoBtn" class="btn btn-success">ì˜ìƒ + í…ìŠ¤íŠ¸ ì—…ë¡œë“œ</button>
    </div>

    <div class="form-group">
        <label>íŒŒì¼ ì„ íƒ (Image)</label>
        <input type="file" id="imageFile" accept="image/*" class="form-control">
        <label>í”„ë¡¬í”„íŠ¸ ì…ë ¥</label>
        <textarea id="imagePrompt" class="form-control" placeholder="í…ìŠ¤íŠ¸ ì„¤ëª… ì…ë ¥"></textarea>
        <button id="uploadImageBtn" class="btn btn-success">ì´ë¯¸ì§€ + í…ìŠ¤íŠ¸ ì—…ë¡œë“œ</button>
    </div>

</div>

<script>
    window.onload = function () {
        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");

        if (code) {
            $.ajax({
                url: "/api/auth/google",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ authorizationCode: code }),
                success: function (data) {
                    if (data.accessToken) {
                        localStorage.setItem("accessToken", "Bearer " + data.accessToken);
                        alert("ë¡œê·¸ì¸ ì„±ê³µ! accessToken ì €ì¥ ì™„ë£Œ.");
                        window.history.replaceState({}, document.title, "/");
                    } else {
                        alert("accessTokenì´ ì—†ìŠµë‹ˆë‹¤.");
                    }
                },
                error: function () {
                    alert("accessToken ìš”ì²­ ì‹¤íŒ¨");
                }
            });
        }
    };

    $('#google-login').click(function () {
        const clientId = '782806232816-4n74niupirb3c6cdarr0gthv2ulnp059.apps.googleusercontent.com';
        const redirectUri = encodeURIComponent('http://localhost:8080/oauth/google/callback');
        const scope = encodeURIComponent('openid profile email');
        const authUrl = `https://accounts.google.com/o/oauth2/auth?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=code&scope=${scope}`;
        window.location.href = authUrl;
    });

    function getAccessToken() {
        return localStorage.getItem("accessToken");
    }

    function uploadVideoWithText(file, prompt) {
        const token = getAccessToken();
        if (!file || !prompt) {
            alert("íŒŒì¼ê³¼ í”„ë¡¬í”„íŠ¸ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        const fileName = encodeURIComponent(file.name);

        $.ajax({
            url: `/api/upload/video?fileName=${fileName}`,
            type: 'GET',
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", token);
            },
            success: function (res) {
                const videoUrl = res.mediaUrl;
                const textUrl = res.textUrl;

                // Step 1. ì˜ìƒ ì—…ë¡œë“œ
                fetch(videoUrl, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'video/mp4' },
                    body: file
                }).then(vRes => {
                    if (!vRes.ok) throw new Error("ì˜ìƒ ì—…ë¡œë“œ ì‹¤íŒ¨");
                    // Step 2. í…ìŠ¤íŠ¸ ì—…ë¡œë“œ
                    return fetch(textUrl, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'text/plain' },
                        body: new Blob([prompt], { type: 'text/plain' })
                    });
                }).then(tRes => {
                    if (tRes.ok) {
                        alert("ì˜ìƒ + í…ìŠ¤íŠ¸ ì—…ë¡œë“œ ì„±ê³µ!");
                    } else {
                        alert("í…ìŠ¤íŠ¸ ì—…ë¡œë“œ ì‹¤íŒ¨");
                    }
                }).catch(err => {
                    console.error(err);
                    alert("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
                });
            },
            error: function () {
                alert("Presigned URL ë°œê¸‰ ì‹¤íŒ¨");
            }
        });
    }

    function uploadImageWithText(file, prompt) {
        const token = getAccessToken();
        if (!file || !prompt) {
            alert("íŒŒì¼ê³¼ í”„ë¡¬í”„íŠ¸ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        const fileName = encodeURIComponent(file.name);
        $.ajax({
            url: `/api/upload/image?fileName=${fileName}`,
            type: 'GET',
            beforeSend: function (xhr) {
                console.log("ğŸš€ Authorization header:", token);
                xhr.setRequestHeader("Authorization", token);
            },
            success: function (res) {
                const imageUrl = res.mediaUrl;
                const textUrl = res.textUrl;

                fetch(imageUrl, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'image/png' },
                    body: file
                }).then(iRes => {
                    if (!iRes.ok) throw new Error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨");
                    return fetch(textUrl, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'text/plain' },
                        body: new Blob([prompt], { type: 'text/plain' })
                    });
                }).then(tRes => {
                    if (tRes.ok) {
                        alert("ì´ë¯¸ì§€ + í…ìŠ¤íŠ¸ ì—…ë¡œë“œ ì„±ê³µ!");
                    } else {
                        alert("í…ìŠ¤íŠ¸ ì—…ë¡œë“œ ì‹¤íŒ¨");
                    }
                }).catch(err => {
                    console.error(err);
                    alert("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
                });
            },
            error: function () {
                alert("Presigned URL ë°œê¸‰ ì‹¤íŒ¨");
            }
        });
    }


    $('#uploadVideoBtn').click(() => {
        const file = document.getElementById('videoFile').files[0];
        const prompt = document.getElementById('videoPrompt').value.trim();
        uploadVideoWithText(file, prompt);
    });

    $('#uploadImageBtn').click(() => {
        const file = document.getElementById('imageFile').files[0];
        const prompt = document.getElementById('imagePrompt').value.trim();
        uploadImageWithText(file, prompt);
    });

</script>
</body>
</html>
