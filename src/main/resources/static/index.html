<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Presigned URL í…ŒìŠ¤íŠ¸</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
</head>
<body>
<div class="container">
    <h1>Google OAuth ë¡œê·¸ì¸</h1>
    <button id="google-login" class="btn btn-primary">Google ë¡œê·¸ì¸</button>

    <hr>

    <h2>ğŸ“¤ Presigned URL í…ŒìŠ¤íŠ¸</h2>

    <div class="form-group">
        <label>íŒŒì¼ ì„ íƒ (Video)</label>
        <input type="file" id="videoFile" accept="video/*" class="form-control">
        <button id="uploadVideoBtn" class="btn btn-success">ì˜ìƒ ì—…ë¡œë“œ</button>
    </div>

    <div class="form-group">
        <label>íŒŒì¼ ì„ íƒ (Image)</label>
        <input type="file" id="imageFile" accept="image/*" class="form-control">
        <button id="uploadImageBtn" class="btn btn-success">ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
    </div>
</div>

<script>
    // âœ… accessToken JSON ì‘ë‹µ íŒŒì‹± (ë¦¬ë‹¤ì´ë ‰íŠ¸ ì§í›„ ì‹¤í–‰)
    window.onload = function () {
        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");

        if (code) {
            // codeë¥¼ ì´ìš©í•´ì„œ ë°±ì—”ë“œì— accessToken ìš”ì²­
            $.ajax({
                url: "/api/auth/google",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ authorizationCode: code }),
                success: function (data) {
                    if (data.accessToken) {
                        localStorage.setItem("accessToken", "Bearer " + data.accessToken);
                        alert("ë¡œê·¸ì¸ ì„±ê³µ! accessToken ì €ì¥ ì™„ë£Œ.");
                        // query string ì œê±° í›„ ë©”ì¸ ë¦¬ë””ë ‰íŠ¸
                        window.history.replaceState({}, document.title, "/");
                    } else {
                        alert("accessTokenì´ ì—†ìŠµë‹ˆë‹¤.");
                    }
                },
                error: function () {
                    alert("accessToken ìš”ì²­ ì‹¤íŒ¨");
                }
            });
        }
    };

    $('#google-login').click(function () {
        const clientId = '782806232816-4n74niupirb3c6cdarr0gthv2ulnp059.apps.googleusercontent.com';
        const redirectUri = encodeURIComponent('http://localhost:8080/oauth/google/callback');
        const scope = encodeURIComponent('openid profile email');
        const authUrl = `https://accounts.google.com/o/oauth2/auth?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=code&scope=${scope}`;
        window.location.href = authUrl;
    });

    function getAccessToken() {
        return localStorage.getItem("accessToken");
    }

    function getTimestamp() {
        const now = new Date();
        const pad = n => n.toString().padStart(2, '0');
        return `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
    }

    function uploadFile(api, file, contentType) {
        if (!file) {
            alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
            return;
        }

        const token = getAccessToken();
        if (!token) {
            alert("Access tokenì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
            return;
        }

        // Step 1: userId ì–»ê¸°ìš© dummy presigned ìš”ì²­
        $.ajax({
            url: `/api/upload/${api}?fileName=dummy`,
            type: 'GET',
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", token);
            },
            success: function (res) {
                const userId = res.userId;
                const timestamp = getTimestamp();
                const originalName = file.name;
                const objectName = `${userId}/${api}/${timestamp}_${originalName}`;
                const encodedName = encodeURIComponent(objectName);

                // Step 2: presigned URL ì¬ìš”ì²­
                $.ajax({
                    url: `/api/upload/${api}?fileName=${encodedName}`,
                    type: 'GET',
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("Authorization", token);
                    },
                    success: function (urlRes) {
                        const presignedUrl = urlRes.url;
                        fetch(presignedUrl, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': contentType
                            },
                            body: file
                        }).then(response => {
                            if (response.ok) {
                                alert(`${api} ì—…ë¡œë“œ ì„±ê³µ\nê²½ë¡œ: ${objectName}`);
                            } else {
                                alert(`${api} ì—…ë¡œë“œ ì‹¤íŒ¨: ` + response.statusText);
                            }
                        }).catch(error => {
                            console.error(error);
                            alert("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
                        });
                    },
                    error: function () {
                        alert("Presigned URL ì¬ìš”ì²­ ì‹¤íŒ¨");
                    }
                });
            },
            error: function () {
                alert("userId ì¡°íšŒ ì‹¤íŒ¨");
            }
        });
    }

    $('#uploadVideoBtn').click(() => {
        const file = document.getElementById('videoFile').files[0];
        uploadFile('video', file, 'video/mp4');
    });

    $('#uploadImageBtn').click(() => {
        const file = document.getElementById('imageFile').files[0];
        uploadFile('image', file, 'image/png');
    });
</script>
</body>
</html>
