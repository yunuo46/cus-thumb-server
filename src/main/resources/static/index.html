<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Presigned URL í…ŒìŠ¤íŠ¸</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <style>
        body { padding: 20px; }
        .container { max-width: 960px; }
        .form-group { margin-bottom: 20px; }
        textarea { resize: vertical; }
        .thumbnail-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .thumbnail-item {
            border: 1px solid #ddd;
            padding: 5px;
            text-align: center;
            cursor: pointer;
        }
        .thumbnail-item.selected {
            border: 2px solid #007bff;
        }
        .thumbnail-item img {
            width: 150px;
            height: 100px;
            object-fit: cover;
        }
        .thumbnail-item p {
            margin-top: 5px;
            font-size: 0.8em;
            word-break: break-all;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Google OAuth ë¡œê·¸ì¸</h1>
    <p id="loginStatus">ë¡œê·¸ì¸ í•„ìš”</p>
    <button id="google-login" class="btn btn-primary">Google ë¡œê·¸ì¸</button>

    <hr>

    <h2>ğŸ–¼ï¸ ì¸ë„¤ì¼ ìƒì„±</h2>
    <div class="form-group">
        <label>ìƒì„±í•  ì¸ë„¤ì¼ íƒ€ì… ì„ íƒ:</label><br>
        <label class="checkbox-inline"><input type="checkbox" name="thumbnailType" value="cartoon"> Cartoon</label>
        <label class="checkbox-inline"><input type="checkbox" name="thumbnailType" value="anime"> Anime</label>
        <label class="checkbox-inline"><input type="checkbox" name="thumbnailType" value="realistic"> Realistic</label>
        <label class="checkbox-inline"><input type="checkbox" name="thumbnailType" value="oil_painting"> Oil Painting</label>
        <label class="checkbox-inline"><input type="checkbox" name="thumbnailType" value="sketch"> Sketch</label>
    </div>
    <button id="createThumbnailBtn" class="btn btn-warning">ì¸ë„¤ì¼ ìƒì„± ìš”ì²­</button>

    <hr>

    <h2>âœ¨ ì¸ë„¤ì¼ í¸ì§‘</h2>
    <div class="form-group">
        <label>í¸ì§‘í•  ì¸ë„¤ì¼ ì„ íƒ (ì•„ë˜ ëª©ë¡ì—ì„œ í´ë¦­)</label><br>
        <input type="hidden" id="selectedThumbnailId">
        <input type="text" id="selectedThumbnailUrl" class="form-control" placeholder="ì„ íƒëœ ì¸ë„¤ì¼ URL" readonly>
    </div>
    <div class="form-group">
        <label>ìƒˆë¡œìš´ í”„ë¡¬í”„íŠ¸ ì…ë ¥:</label>
        <textarea id="editPrompt" class="form-control" placeholder="ìƒˆë¡œìš´ ì¸ë„¤ì¼ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."></textarea>
    </div>
    <button id="editThumbnailBtn" class="btn btn-info">ì¸ë„¤ì¼ í¸ì§‘ ìš”ì²­</button>

    <hr>

    <h2>ğŸ“‹ ì¸ë„¤ì¼ ëª©ë¡</h2>
    <button id="getThumbnailsBtn" class="btn btn-default">ì¸ë„¤ì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <div id="thumbnailList" class="thumbnail-container">
        <p id="noThumbnailsMessage" style="display: none;">ìƒì„±ëœ ì¸ë„¤ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>

    <hr>

    <h2>ğŸ“¤ Presigned URL í…ŒìŠ¤íŠ¸ (ì˜ìƒ/ì´ë¯¸ì§€ ì—…ë¡œë“œ)</h2>

    <div class="form-group">
        <label>íŒŒì¼ ì„ íƒ (Video)</label>
        <input type="file" id="videoFile" accept="video/*" class="form-control">
        <label>í”„ë¡¬í”„íŠ¸ ì…ë ¥</label>
        <textarea id="videoPrompt" class="form-control" placeholder="ë¹„ë””ì˜¤ì— ëŒ€í•œ í…ìŠ¤íŠ¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
        <button id="uploadVideoBtn" class="btn btn-success">ì˜ìƒ + í…ìŠ¤íŠ¸ ì—…ë¡œë“œ</button>
    </div>

    <div class="form-group">
        <label>íŒŒì¼ ì„ íƒ (Image)</label>
        <input type="file" id="imageFile" accept="image/*" class="form-control">
        <label>í”„ë¡¬í”„íŠ¸ ì…ë ¥</label>
        <textarea id="imagePrompt" class="form-control" placeholder="ì´ë¯¸ì§€ì— ëŒ€í•œ í…ìŠ¤íŠ¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
        <button id="uploadImageBtn" class="btn btn-success">ì´ë¯¸ì§€ + í…ìŠ¤íŠ¸ ì—…ë¡œë“œ</button>
    </div>

</div>

<script>
    const API_BASE_URL = "/api"; // API ê¸°ë³¸ ê²½ë¡œ

    window.onload = function () {
        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");

        if (code) {
            // OAuth ì½œë°±ìœ¼ë¡œ ë°›ì€ ì½”ë“œë¡œ accessToken ìš”ì²­
            $.ajax({
                url: `${API_BASE_URL}/auth/google`,
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ authorizationCode: code }),
                success: function (data) {
                    if (data.accessToken) {
                        localStorage.setItem("accessToken", "Bearer " + data.accessToken);
                        alert("ë¡œê·¸ì¸ ì„±ê³µ! accessTokenì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        $("#loginStatus").text("ë¡œê·¸ì¸ë¨ âœ…");
                        // URLì—ì„œ ì½”ë“œ ì œê±° (ìƒˆë¡œê³ ì¹¨ ì‹œ ì¬ë¡œê·¸ì¸ ë°©ì§€)
                        window.history.replaceState({}, document.title, window.location.pathname);
                        // ë¡œê·¸ì¸ ì„±ê³µ í›„ ì¸ë„¤ì¼ ëª©ë¡ ìë™ ë¡œë“œ
                        getThumbnails();
                    } else {
                        alert("accessTokenì´ ì—†ìŠµë‹ˆë‹¤.");
                    }
                },
                error: function (xhr) {
                    console.error("accessToken ìš”ì²­ ì‹¤íŒ¨:", xhr);
                    alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + (xhr.responseJSON?.message || xhr.statusText));
                }
            });
        } else {
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ accessToken í™•ì¸
            if (getAccessToken()) {
                $("#loginStatus").text("ë¡œê·¸ì¸ë¨ âœ…");
                getThumbnails(); // accessTokenì´ ìˆìœ¼ë©´ ì¸ë„¤ì¼ ëª©ë¡ ìë™ ë¡œë“œ
            }
        }
    };

    $('#google-login').click(function () {
        // Google OAuth í´ë¼ì´ì–¸íŠ¸ IDëŠ” ë³¸ì¸ì˜ ê²ƒìœ¼ë¡œ ëŒ€ì²´í•´ì•¼ í•©ë‹ˆë‹¤.
        const clientId = '782806232816-4n74niupirb3c6cdarr0gthv2ulnp059.apps.googleusercontent.com';
        const redirectUri = encodeURIComponent('http://localhost:8080/oauth/google/callback'); // ì‹¤ì œ ë¦¬ë‹¤ì´ë ‰íŠ¸ URI
        const scope = encodeURIComponent('openid profile email');
        const authUrl = `https://accounts.google.com/o/oauth2/auth?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=code&scope=${scope}`;
        window.location.href = authUrl;
    });

    function getAccessToken() {
        return localStorage.getItem("accessToken");
    }

    // íŒŒì¼ ì—…ë¡œë“œ (ì˜ìƒ/ì´ë¯¸ì§€)
    function uploadFileWithText(file, prompt, type) {
        const token = getAccessToken();
        if (!token) {
            alert("accessTokenì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.");
            return;
        }
        if (!file || !prompt) {
            alert("íŒŒì¼ê³¼ í”„ë¡¬í”„íŠ¸ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        const fileName = encodeURIComponent(file.name);
        const uploadApiUrl = `${API_BASE_URL}/upload/${type}?fileName=${fileName}`;
        const contentType = (type === 'video') ? 'video/mp4' : 'image/png'; // ì˜ˆì‹œ. ì‹¤ì œ íŒŒì¼ íƒ€ì…ì— ë”°ë¼ ì¡°ì ˆ

        $.ajax({
            url: uploadApiUrl,
            type: 'GET',
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", token);
            },
            success: function (res) {
                const mediaUrl = res.mediaUrl;
                const textUrl = res.textUrl;

                // Step 1. ë¯¸ë””ì–´ íŒŒì¼ ì—…ë¡œë“œ
                fetch(mediaUrl, {
                    method: 'PUT',
                    headers: { 'Content-Type': contentType },
                    body: file
                }).then(mediaRes => {
                    if (!mediaRes.ok) throw new Error(`${type} ì—…ë¡œë“œ ì‹¤íŒ¨: ${mediaRes.status}`);
                    // Step 2. í…ìŠ¤íŠ¸ íŒŒì¼ ì—…ë¡œë“œ
                    return fetch(textUrl, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'text/plain' },
                        body: new Blob([prompt], { type: 'text/plain' })
                    });
                }).then(textRes => {
                    if (textRes.ok) {
                        alert(`${type} + í…ìŠ¤íŠ¸ ì—…ë¡œë“œ ì„±ê³µ!`);
                    } else {
                        alert(`í…ìŠ¤íŠ¸ ì—…ë¡œë“œ ì‹¤íŒ¨: ${textRes.status}`);
                    }
                }).catch(err => {
                    console.error(`ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ (${type}):`, err);
                    alert(`ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ (${type}): ${err.message || err}`);
                });
            },
            error: function (xhr) {
                console.error(`Presigned URL ë°œê¸‰ ì‹¤íŒ¨ (${type}):`, xhr);
                alert(`Presigned URL ë°œê¸‰ ì‹¤íŒ¨ (${type}): ${xhr.responseJSON?.message || xhr.statusText}`);
            }
        });
    }

    $('#uploadVideoBtn').click(() => {
        const file = document.getElementById('videoFile').files[0];
        const prompt = document.getElementById('videoPrompt').value.trim();
        uploadFileWithText(file, prompt, 'video');
    });

    $('#uploadImageBtn').click(() => {
        const file = document.getElementById('imageFile').files[0];
        const prompt = document.getElementById('imagePrompt').value.trim();
        uploadFileWithText(file, prompt, 'image');
    });

    // ì¸ë„¤ì¼ ìƒì„± ìš”ì²­
    $('#createThumbnailBtn').click(() => {
        const token = getAccessToken();
        if (!token) {
            alert("accessTokenì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.");
            return;
        }

        const selectedTypes = Array.from(document.querySelectorAll('input[name="thumbnailType"]:checked'))
            .map(cb => cb.value);

        if (selectedTypes.length === 0) {
            alert("ìƒì„±í•  ì¸ë„¤ì¼ íƒ€ì…ì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•˜ì„¸ìš”.");
            return;
        }

        $.ajax({
            url: `${API_BASE_URL}/thumbnails`,
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({ types: selectedTypes }),
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", token);
            },
            success: function (res) {
                console.log("ì¸ë„¤ì¼ ìƒì„± ê²°ê³¼:", res);
                alert("ì¸ë„¤ì¼ ìƒì„± ì„±ê³µ! ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
                getThumbnails(); // ìƒì„± í›„ ëª©ë¡ ìë™ ì—…ë°ì´íŠ¸
            },
            error: function (xhr) {
                console.error("ì¸ë„¤ì¼ ìƒì„± ì‹¤íŒ¨:", xhr);
                alert("ì¸ë„¤ì¼ ìƒì„± ì‹¤íŒ¨: " + (xhr.responseJSON?.message || xhr.statusText));
            }
        });
    });

    // ì¸ë„¤ì¼ ëª©ë¡ ì¡°íšŒ
    $('#getThumbnailsBtn').click(getThumbnails);

    function getThumbnails() {
        const token = getAccessToken();
        if (!token) {
            alert("accessTokenì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.");
            return;
        }

        $.ajax({
            url: `${API_BASE_URL}/thumbnails`,
            method: "GET",
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", token);
            },
            success: function (res) {
                console.log("ì¸ë„¤ì¼ ëª©ë¡:", res);
                displayThumbnails(res);
            },
            error: function (xhr) {
                console.error("ì¸ë„¤ì¼ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:", xhr);
                alert("ì¸ë„¤ì¼ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: " + (xhr.responseJSON?.message || xhr.statusText));
            }
        });
    }

    function displayThumbnails(thumbnails) {
        const $thumbnailList = $('#thumbnailList');
        $thumbnailList.empty(); // ê¸°ì¡´ ëª©ë¡ ë¹„ìš°ê¸°

        if (thumbnails && thumbnails.length > 0) {
            $('#noThumbnailsMessage').hide();
            thumbnails.forEach(thumb => {
                const $thumbItem = $(`<div class="thumbnail-item" data-id="${thumb.id}" data-url="${thumb.url}">
                    <img src="${thumb.url}" alt="Thumbnail">
                    <p>${thumb.url.split('/').pop()}</p>
                </div>`);
                $thumbItem.click(function() {
                    $('.thumbnail-item').removeClass('selected');
                    $(this).addClass('selected');
                    $('#selectedThumbnailId').val(thumb.id);
                    $('#selectedThumbnailUrl').val(thumb.url);
                });
                $thumbnailList.append($thumbItem);
            });
        } else {
            $('#noThumbnailsMessage').show();
        }
    }

    // ì¸ë„¤ì¼ í¸ì§‘ ìš”ì²­
    $('#editThumbnailBtn').click(() => {
        const token = getAccessToken();
        if (!token) {
            alert("accessTokenì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.");
            return;
        }

        const thumbnailId = $('#selectedThumbnailId').val();
        const prompt = $('#editPrompt').val().trim();

        if (!thumbnailId) {
            alert("í¸ì§‘í•  ì¸ë„¤ì¼ì„ ëª©ë¡ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }
        if (!prompt) {
            alert("ìƒˆë¡œìš´ ì¸ë„¤ì¼ ìƒì„±ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        $.ajax({
            url: `${API_BASE_URL}/thumbnails/edit`,
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({ id: thumbnailId, prompt: prompt }),
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", token);
            },
            success: function (res) {
                console.log("ì¸ë„¤ì¼ í¸ì§‘ ê²°ê³¼:", res);
                alert("ì¸ë„¤ì¼ í¸ì§‘ ì„±ê³µ! ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
                $('#selectedThumbnailId').val(''); // ì„ íƒ ì´ˆê¸°í™”
                $('#selectedThumbnailUrl').val('');
                $('#editPrompt').val('');
                getThumbnails(); // í¸ì§‘ í›„ ëª©ë¡ ìë™ ì—…ë°ì´íŠ¸
            },
            error: function (xhr) {
                console.error("ì¸ë„¤ì¼ í¸ì§‘ ì‹¤íŒ¨:", xhr);
                alert("ì¸ë„¤ì¼ í¸ì§‘ ì‹¤íŒ¨: " + (xhr.responseJSON?.message || xhr.statusText));
            }
        });
    });

</script>
</body>
</html>